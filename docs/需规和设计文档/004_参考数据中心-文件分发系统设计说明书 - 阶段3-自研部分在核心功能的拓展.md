<div align='center' ><font size='50'>参考数据中心-文件分发系统</font></div>
<div align='center' ><font size='50'>设计说明书</font></div>
[toc]

# 1: 项目概述与名词解释

## 1.1 概述

- **参考数据中心:** 是 G4 项目中的一个为每日交易业务提供数据存储、数据处理、数据快速分发能力的系统。
- **为什么需要参考数据中心-文件分发系统:**
  - **现有文件传输系统的痛点**
    - **1.支持的连接数低:** 现有文件传输系统,单台 VMS 系统主机同一时刻维持的 连接不超过 10 个，单台 linux 主机同一时刻维持的连接不超过 30 个；
    - **2.文件传输节点的数量少:** 现有文件传输系统，传输节点数量上限为 32 个；
    - **3.文件并发传输数量少:** 现有文件传输系统，文件传输并发数配置不超过 16；
    - **4.对带宽资源的占用不可控:** 现有文件传输系统，当同时传输大量文件的时候，会导致带宽资源被大量占用，文件传输服务器性能被大量消耗。
  - 为了解决上述现有文件传输系统的痛点，提升业务的效率和稳定性，遂研发新的文件分发系统——参考数据中心-文件分发系统。
- **参考数据存储原则:** 一份数据，多份视图，各取所需，每日更新。

## 1.2 名词解释

- **名词解释:**
  |名词|含义|备注|
  |---|---|---|
  |**参考数据**|指每日交易系统启动所需的所有数据。||
  |**参考数据中心**|指整个参考数据中心系统，包括参考`数据中心数据库`，`参考数据中心文件分发系统`，`参考数据中心文件分发操控中心`以及其他系统。||
  |**参考数据中心数据库**|指的是参考数据中心存放数据的原始数据表。||
  |**参考数据中心-文件分发系统**|指分发参考数据文件到各主机的文件分发系统。包括`参考数据中心-文件分发系统客户端集合`,`参考数据中心-文件分发系统服务端集合`两个子模块|下文`文件分发系统`都指的是`参考数据中心-文件分发系统`|
  |**参考数据中心-文件分发系统客户端集合**|是一组可执行程序，包括**PushCLI**（上传文件客户端）; **PullCLI**（下载文件客户端）; **RemoveCLI**（从文件分发系统清理文件客户端）||
  |**参考数据中心-文件分发系统服务端集合**|由一系列可执行程序构成 P2P 网络和提供对文件操作的服务||
  |**CSGW**|指的是现有的存储网关，可以提供数据分发操作的数据源和目标源||

# 2: 项目设计规范及要点

## 2.1 设计规范

项目设计规范按照: 《G4 项目研发规范与流程》为准，包括基础技术约束和研发体系两个大的方向。

- **基础技术约束:** 对项目开发从操作系统、开发语言选型、研发工具、技术环境等方面做了详细的规范与指导；
- **研发体系:** 从系统评审规范、组件分解与研发流程、质量保证、文档说明等方面做了完善的研发流程规范

## 2.2 设计要点

- **要点 1:** 根据《G4 项目研发规范与流程》1.2 章节，参考数据中心应选用适宜的技术栈，并避免引入过多语言与依赖；
- **要点 2:** 执行效率要高，对外部的依赖要少；
- **要点 3:** 部署便捷，使用方便，对维护使用人员要友好；
- **要点 4:** 故障隔离性，单个文件上传或下载节点故障不会影响整个系统；
- **要点 5:** 可用性与容错性，当某个节点发生错误时，可以对该节点的任务进行重新执行生成所需要的数据；

# 3: 参考数据中心-文件分发系统视图

参考数据中心-文件分发系统由一系列可执行程序构成。
文件分发系统客户端集合由 **PushCLI**，**PullCLI**, **Agent**，**RemoveCLI** 4 个可执行程序组成；
文件分发系统服务端集合由**Proxy**，**Origin**，**Tracker**，**Build-index**，**对象存储服务**组成；

- **RemoveCLI**
  - 从文件分发系统清理对应的文件
- **PushCLI**
  - 部署在每一个需要进行上传文件主机上
  - 实现文件上传的功能
  - 提供对上传功能的拓展
- **PullCLI**
  - 部署在每一个需要进行下载文件主机上
  - 实现文件下载的功能
  - 提供对下载功能的拓展
- **Agent**
  - 对 Tracker 返回的 peers 列表之间进行相互连接
  - 提供文件下载的接口
- **Origin**
  - 专用的播种器 Seeder
  - 将文件存储在磁盘上或者文件系统(FS)或者对象存储
  - 形成一个自我修复的 hash 环以分配负载
- **Tracker**
  - 追踪对等节点 peer 有哪些数据
  - 提供一个对等节点 peer 连接任何给定文件的有序列表
- **Proxy**
  - 实现文件注册接口
  - 上传文件到负责的 Origin
- **Build-Index**
  - 映射人们可读的 tag 给文件摘要
  - Build-Index 不保证一致性：clientCLI 应该使用唯一的 tags。
  - 增强 file 在 cluster 中的复制(具有重试功能的简单重复队列)
  - 将 tags 作为文件存储在文件系统

## 3.1 整体视图

**参考数据中心-文件分发系统与其他系统的依赖关系，如下图所示：**

![](./statics/016_G4参考数据中心设计图-1.svg)

## 3.2 参考数据中心-文件分发系统内部视图

---

**上传文件的逻辑示意图:**

<!-- ![](./statics/016_G4参考数据中心设计图-2-1.svg) -->

![](./statics/016_G4参考数据中心设计图-5-1.svg)

- 上传文件到文件分发系统后台

  1. 调用上传文件命令
  2. **PushCLI**处理上传文件的命令和参数，发送 push file 请求给**Proxy**；
  3. **Proxy**发送 put tag 请求给**Build-Index**；
  4. **Proxy**发送 push file 请求给**Origin**；
  5. **Origin**将文件上传到对象存储；

- 上传文件到文件分发系统后台
  1. 调用上传文件命令
  2. **PushCLI**处理上传文件的命令和参数，使用 FTP 发送文件给**CSGW**；

---

**下载文件的逻辑示意图:**

<!-- ![](./statics/016_G4参考数据中心设计图-2-2.svg) -->

![](./statics/016_G4参考数据中心设计图-5-2.svg)

- 从文件分发系统后台下载文件

  1. 调用下载文件的命令；
  2. **PullCLI**处理下载文件的命令和参数，发送 pull file 请求给**Agent**；
  3. **Agent** 从 **Build-Index** 根据 name 获取文件 tag,通过 tag 获取对应的 digest;
  4. **Agent** 向**Tracker**获取 peers 列表；
  5. **Tracker** 通过**Origin**获取文件；
  6. **Origin** 向 peers 播种文件 torrent；
  7. **Agent** 与其他 peer 上的**Agent**构成 P2P 网络；
  8. **PullCLI** 通过**Agent**根据 torrent 从**origin**和其他**Agent**下载文件到本地。

- 从 CSGW 下载文件
  1. 调用下载文件命令
  2. **PushCLI**处理上传文件的命令和参数，使用 FTP 从**CSGW**下载文件；

---

# 4: 分发命令参数模型设计

## 4.1 文件 tag 的规范

- **文件的 tag :** 是以可读的方式对文件做标签，tag 和文件的摘要 digest 做一一映射，tag 具有唯一性；
- **tag 的构成说明:** （以文件 xxx.txt 为例）
  - **digest 摘要:** 计算文件的摘要信息 `sha256:773f15a2f2368be3ef88bfc29cc602bac5bd918f1f6cd14b24502d8760e04173`
  - **tag 构成规则:** `srcHost-srcDir-fileName:version`
    | 参数 | 参数名 | 说明 | 类型 | 默认值 | 是否必需 |
    | ------- | ------------ | ------------------------------------- | --------------------- | ---------------- | -------- |
    | srcHost | 源地址 | 上传资源主机 ip | String | | true |
    | srcDir | 源路径 | 源文件所在绝对路径 | String | | true |
    | fileName | 源文件名称 | | String | | true |
    | version | 源文件版本 | 默认是`latest`| String | | true |

## 4.2 上传文件到文件分发系统的命令参数

```bash
# 命令行调用直接上传文件xxx.txt的命令
PushCLI push  [args]... xxx.txt
```

| 参数    | 参数名       | 说明                                  | 类型                  | 默认值           | 是否必需 |
| ------- | ------------ | ------------------------------------- | --------------------- | ---------------- | -------- |
| srcHost | 源地址       | 上传资源主机 ip                       | String                |                  | true     |
| srcPath | 源目录       | 上传资源的绝对路径                    | String                |                  | true     |
| resType | 资源类型     | 资源类型是文件、目录                  | Enum [file,directory] | file             | true     |
| resDesc | 资源描述     | 资源的描述信息，可为空                | String                |                  | false    |
| dstType | 目标类型     | CSGW 或文件分发系统后台               | String                | 文件分发系统后台 | true     |
| dstHost | 目标地址     | CSGW 地址，文件分发系统后台地址       | String                |                  | true     |
| timeout | 上传超时时间 | 文件或者目录上传超时时间,单位是秒 (s) | Int                   | 30               | false    |
| hasFlag | 源通知方式   | F-flag 文件，N-无 flag 文件           | String                | 30               | true     |
| tag     | 文件的 tag   | 文件的标签，具有唯一性                | String                | 30               | true     |

## 4.3 下载文件到文件分发系统的命令参数

```bash
# 命令行直接调用下载文件xxx.txt的命令
PullCLI pull  [args]... xxx.txt
```

| 参数    | 参数名         | 说明                                                         | 类型                  | 默认值 | 是否必需 |
| ------- | -------------- | ------------------------------------------------------------ | --------------------- | ------ | -------- |
| srcHost | 源地址         | 下载资源的源地址,如 CSGW 或者文件分发系统                    | String                |        | true     |
| resType | 资源类型       | 资源类型是文件、目录                                         | Enum [file,directory] | file   | true     |
| resDesc | 资源描述       | 资源的描述信息，可为空                                       | String                |        | false    |
| dstHost | 目标地址       | 下载资源的主机                                               | String                |        | true     |
| dstPath | 目标目录       | 下载资源存放的绝对路径                                       | String                |        | true     |
| timeout | 下载超时时间   | 下载资源超时时间,单位是秒 (s)                                | Int                   | 10     | false    |
| hasFlag | 源通知方式     | F-flag 文件，N-无 flag 文件                                  | String                |        | true     |
| isCover | 是否覆盖的标识 | 下载文件若已存在，在本地是否覆盖                             | Boolean               | true   | true     |
| newName | 新文件名称     | 如果名字已存在，且覆盖标识是 false，则对新下载资源进行重命名 | String                | true   | false    |

## 4.4 从文件分发系统清理文件的命令参数

```bash
# 从文件分发系统清理文件xxx.txt的命令
AgentPushCLI remove xxx.txt [args]...
```

| 参数 | 参数名           | 说明 | 类型 | 默认值 | 是否必需 |
| ---- | ---------------- | ---- | ---- | ------ | -------- |
| tag  | 被清理文件的 tag |      |      |        | true     |

- 通过调用该命令，会清理文件分发系统中对应的文件，本地已下载的文件资源不受影响
- 通过配置文件分发系统的配置文件，可以给每一个下载的文件都设置对应的 TTL，下载在本地的文件过期后自动被清理

# 5: 上传下载流程概述

## 5.1 上传文件流程概述

以下是参考数据中心-文件分发系统进行文件分发的示意图:(共有 3 种情况)
![](./statics/016_G4参考数据中心设计图-4.svg)

## 5.2 下载文件流程概述

(略)...

# 6：各可执行程序详细设计

## 6.1 文件分发系统客户端可执行程序集合

### 6.1.1 PushCLI

#### 6.1.1.1 PushCLI 处理命令参数流程说明

![](./statics/017_G4参考数据中心设计图-1.svg)

### 6.1.2 PullCLI

#### 6.1.2.1 PullCLI 处理命令参数流程说明

![](./statics/017_G4参考数据中心设计图-2.svg)

### 6.1.3 RemoveCLI

TODO...

#### 6.1.2.1 RemoveCLI 处理命令参数流程说明

## 6.2 文件分发系统服务端可执行程序集合

### 6.2.1 Agent

### 6.2.1.1 Agent 进程启动流程分析

![](./statics/017_G4参考数据中心设计图-agent-start.svg)

### 6.2.1.2 Agent 处理请求流程分析

### 6.2.1.3 Agent 类图

### 6.2.2 Proxy

### 6.2.2.1 Proxy 进程启动流程分析

### 6.2.2.2 Proxy 处理请求流程分析

### 6.2.2.3 Proxy 类图

### 6.2.3 Origin

### 6.2.3.1 Origin 进程启动流程分析

### 6.2.3.2 Origin 处理请求流程分析

### 6.2.3.3 Origin 类图

### 6.2.4 Tracker

### 6.2.4.1 Tracker 进程启动流程分析

### 6.2.4.2 Tracker 处理请求流程分析

### 6.2.4.3 Tracker 类图

### 6.2.5 Build-Index

### 6.2.5.1 Build-Index 进程启动流程分析

### 6.2.5.2 Build-Index 处理请求流程分析

### 6.2.5.3 Build-Index 类图

### 6.2.6 对象存储

待定...

## 6.3 文件分发系统操控中心可执行程序集合

```go
参考数据中心-文件分发系统操控中心
│
├── 任务调度引擎（来自G4项目操控中心）
│
├── 任务调度流程（来自G4项目操控中心定义的任务调度模板）
│
└── 任务调度流程中的分发文件的task任务（根据实际业务编写）
```

1. 对文件分发客户端 PushCLI / PullCLI 的命令和参数进行封装成一个 task 程序，方便被任务调度流程进行调用执行，进而通过 task 远程的执行文件分发指令；
2. 在执行 task 的时候从配置中心，环境变量，文件操控中心的高可用数据等地方获取参数；
3. 任务 task 的执行状态，执行结果，执行日志等根据任务调度引擎做适配；

- **任务调度引擎调度流程表达式**
  来自 G4 项目操控中心
- **文件分发系统操控中心对文件分发任务流程的调度**
  来自 G4 项目操控中心
- **文件分发系统操控中心对文件分发任务流程的监控**
  来自 G4 项目操控中心
- **文件分发系统操控任务调度流程示意:**
  要将`192.168.1.1`上的`/usr/local/data/xxx交易数据.txt`分别发给`192.168.1.10`,`192.168.1.11`,`192.168.1.12`对应的目录下。

  ```json
  192.168.1.1/usr/local/data/xxx交易数据.txt ---> 192.168.1.10/usr/local/data/xxx交易数据.txt
  192.168.1.1/usr/local/data/xxx交易数据.txt ---> 192.168.1.11/usr/local/data/xxx交易数据.txt
  192.168.1.1/usr/local/data/xxx交易数据.txt ---> 192.168.1.12/usr/local/data/xxx交易数据.txt
  ```

  具体以 G4 项目操控中心为准

# 7: 参考数据中心-文件分发系统部署

参考数据中心支持 docker 和二进制部署两种方式。

## 7.1 使用 docker 模式进行部署

- 启动文件分发系统客户端 client (kraken-agent)

```bash
# Define agent ports.
AGENT_REGISTRY_PORT=16000
AGENT_PEER_PORT=16001
AGENT_SERVER_PORT=16002

HOSTNAME=172.17.0.1

# Container config.
AGENT_CONTAINER_NAME=kraken-agent-one

# docker run
docker run -d \
-p 16000:16000 \
-p 16001:16001 \
-p 16002:16002 \
-v /mnt/e/sse/kraken/examples/devcluster/config/agent/development.yaml:/etc/kraken/config/agent/development.yaml \
--name kraken-agent-one kraken-agent:dev \
/usr/bin/kraken-agent \
--config=/etc/kraken/config/agent/development.yaml \
--peer-ip=172.17.0.1 \
--peer-port=16001 \
--agent-server-port=16002 \
--agent-registry-port=16000
```

- 启动文件分发系统服务端各组件 proxy,origin,tracker,build-index 组件组成的一个集群容器

```bash
# Define optional storage ports.
TESTFS_PORT=14000
REDIS_PORT=14001

# Define herd ports.
PROXY_PORT=15000
ORIGIN_PEER_PORT=15001
ORIGIN_SERVER_PORT=15002
TRACKER_PORT=15003
BUILD_INDEX_PORT=15004
PROXY_SERVER_PORT=15005

HOSTNAME=172.17.0.1

# docker run
docker run -d \
-p 14000:14000 \
-p 15000:15000 \
-p 15001:15001 \
-p 15002:15002 \
-p 15003:15003 \
-p 15004:15004 \
-p 15005:15005 \
-v /mnt/e/sse/kraken/examples/devcluster/herd_param.sh:/etc/kraken/herd_param.sh \
-v /mnt/e/sse/kraken/examples/devcluster/config/push-cli/development.yaml:/etc/kraken/config/push-cli/development.yaml \
-v /mnt/e/sse/kraken/examples/devcluster/config/origin/development.yaml:/etc/kraken/config/origin/development.yaml \
-v /mnt/e/sse/kraken/examples/devcluster/config/tracker/development.yaml:/etc/kraken/config/tracker/development.yaml \
-v /mnt/e/sse/kraken/examples/devcluster/config/build-index/development.yaml:/etc/kraken/config/build-index/development.yaml \
-v /mnt/e/sse/kraken/examples/devcluster/herd_start_processes.sh:/etc/kraken/herd_start_processes.sh \
--name kraken-herd kraken-herd:dev \
./herd_start_processes.sh
```

### 7.2 使用可执行文件模式进行部署

- 部署依赖环境；
- 将文件分发服务端可执行程序集合直接运行在对应主机上；
- 按需将文件分发客户端可执行程序集合部署在需要进行分发的主机上；

# 8: 项目测试

## 8.1 对代码进行单元测试

- 编码的时候，进行业务逻辑的单元测试；
- 对项目各组件代码，进行测试覆盖度；

## 8.2 对文件分发系统客户端 Client,服务端 Server 各功能进行测试

- 对上传/下载文件、参数命令解析等进行功能测试；
- 根据业务情况，对多种业务分支进行测试；

## 8.3 对文件分发的任务进行测试

- 直接调用文件分发任务，进行文件分发功能测试
- 使用任务调度流程，进行文件分发功能测试

## 8.5 文件分发操控中心，对系统各功能进行测试

# 9: 应急与错误恢复

- 通过文件分发系统操控中心查看文件分发调度流程的执行情况；
- 当文件分发调度流程执行失败，通过文件分发操控中心查看是哪个任务执行失败，并对失败的任务进行重跑，也可以对整个流程进行重跑；
- 当文件分发操控中心无法对某个任务流程进行调度，可以通过手动方式执行对应的任务进行错误应急；

# 10: 发展与展望

- 提高稳定性与性能；
- 提高可用性与可扩展性，满足各种复杂的业务场景；
