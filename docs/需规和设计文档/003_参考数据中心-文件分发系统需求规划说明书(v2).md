<div align='center' ><font size='50'>参考数据中心-文件分发系统</font></div>
<div align='center'><font size='50'>需求规划说明书</font></div>

[toc]

# 1: 需求概述

## 1.1 概述

- **参考数据中心:** 是 G4 项目中的一个为每日交易业务提供数据存储、数据处理、数据快速分发能力的系统。
- **为什么需要参考数据中心-文件分发系统:**
  - **现有文件传输系统的痛点**
    - **1.支持的连接数低:** 现有文件传输系统,单台 VMS 系统主机同一时刻维持的 连接不超过 10 个，单台 linux 主机同一时刻维持的连接不超过 30 个；
    - **2.文件传输节点的数量少:** 现有文件传输系统，传输节点数量上限为 32 个；
    - **3.文件并发传输数量少:** 现有文件传输系统，文件传输并发数配置不超过 16；
    - **4.对带宽资源的占用不可控:** 现有文件传输系统，当同时传输大量文件的时候，会导致带宽资源被大量占用，文件传输服务器性能被大量消耗。
  - 为了解决上述现有文件传输系统的痛点，提升业务的效率和稳定性，遂研发新的文件分发系统——参考数据中心-文件分发系统。

## 1.2 名词解释

**名词解释:**
|名词|含义|备注|
|---|---|---|
|**交易主机集群**|指的是部署运行`G4-交易系统`的主机集群||
|**参考数据-文件分发系统**|指的是参考数据中心-文件分发系统，具备资源上传，下载与清理功能。|下文`文件分发系统`都指的是`参考数据中心-文件分发系统`|
|**配置中心**|指的是 G4 项目的配置中心||
|**CSGW**|指的是现有的存储网关，可以提供数据分发的数据源和目标源||
|**参考数据中心数据库**|指的是 G4 项目参考数据中心的数据库||
|**参考数据中心-文件分发系统操控中心**|指的是 G4 项目参考数据中心一个通过 Web UI 操控服务，可以通过 Web 界面操控参考数据中心文件分发命令，以及交易日转换，配置修改等功能|下文`文件分发系统操控中心`都指的是`参考数据中心-文件分发系统操控中心`|
|**任务调度引擎**|指的是 G4 项目参考数据中心-文件分发操控中心的任务调度引擎|下文`任务调度引擎`都指的是`G4 项目参考数据中心-文件分发操控中心的任务调度引擎`|

<!-- |**任务**|指的是子流程中的每一步执行节点来执行命令，通过命令调用对应的程序||
|**子流程**|||
|**流程组**||| -->

# 2: 交互方

**交互方示意图:**

![](./statics/016_G4参考数据中心设计图-1.svg)

## 2.1 交易主机集群

参考数据中心-文件分发系统是给交易主机集群快速分发文件的系统；

## 2.2 参考数据中心数据库

任务调度引擎调度生成文件的命令，通过生成文件的程序从参考数据中心数据库生成对应的文件；

## 2.3 配置中心

文件分发系统操控中心从配置中心获取对应的配置信息，根据配置信息生成新的任务调度流程；

## 2.4 高可用数据库

用来记录文件分发系统操控中心的一些可修改参数，比如交易日，环境号等，还存放一些任务调度执行流程的状态

## 2.5 CSGW 存储网关

文件分发系统所分发文件的来源，目的地可以是**CSGW**

## 2.5 任务调度引擎

G4 项目参考数据中心-文件分发操控中心的任务调度引擎，用来生成任务调度流程，运行任务调度流程，并对任务调度流程进行监控的引擎

# 3: 参考数据中心-文件分发系统的功能需求概述

文件分发系统根据调度引擎的调度，把源文件分发给需要的交易主机。
业务功能需求由以下两类组成:`文件分发处理`、`文件分发调度与监控`。

## 3.1 文件分发处理

### 3.1.1 上传文件的功能需求

```go
// 上传资源命令需要的基本参数
源地址：上传资源主机ip
源目录：上传资源的绝对路径
资源类型：资源类型是文件、目录
资源描述：资源的描述信息，可为空
目标类型：CSGW或文件分发系统后台
目标地址：CSGW地址，文件分发系统后台地址
上传超时时间：默认是30s
源通知方式：F-flag文件，N-无flag文件
```

---

- **[config0 需要做]**

  - [x] (1) **文件上传到存储网关:** 任务调度引擎中的任务通过调用文件分发系统的上传命令和参数，设置上传资源类型是文件类型，上传资源目标是存储网关，将某个文件资源上传到**CSGW 存储网关**；

  - [x] (2) **文件上传到文件分发系统后台:** 任务调度引擎中的任务通过调用文件分发系统的上传命令和参数，设置上传资源类型是文件类型，上传资源目标是文件分发系统后台，将某个文件资源上传到参考数据中心-文件分发系统后台集群；
  - [x] (3) **文件上传时文件名称大小写转换:** 任务调度引擎中的任务在调用文件上传命令时，支持源文件名不变，目的地文件名根据设置参数进行大小写转换；
        **备注：** `VMS 平台文件传输到存储网关后默认文件名为小写字母`；
  - [x] (4) **文件上传时超时控制:** 任务调度引擎中的任务在调用文件分发系统上传命令时，设置上传资源类型是文件类型，设置上传超时时间为 20s(未设置则默认是 30s)，超时后中断上传，文件上传失败；
  - [x] (5) **文件定时上传（循环上传）:** 任务调度引擎中通过 cron 定时脚本调度上传文件的命令，定时任务时间间隔不得小于 2 倍的上传文件超时时间，定时任务时间段过期，停止上传；
        **备注：** `循环传输、公告传输、行情传输目前只支持文件`；
  - [x] (6) **上传目录到存储网关、文件分发系统后台:** 任务调度引擎中的任务通过调用文件分发系统的上传命令和参数，设置上传资源类型是目录类型，上传资源目标是存储网关或者文件分发后台，支持将目录上传到存储网关或文件分发系统后台；
  - [x] (7) **上传目录超时控制:** 任务调度引擎中的任务在调用文件分发系统上传命令时，设置上传资源类型是目录类型，设置上传超时时间为 60s(未设置则默认值 30s)，超时后中断上传，目录上传失败；

---

- **[config0 不需要做]**
  - [ ] (1) **对带有 flag 文件的校验:** 任务调度引擎中的任务在调用文件分发系统上传命令时，如果上传参数源文件通知方式是 flag，源主机如果有 flag 文件，就先对比 flag 文件修改时间以及 md5 码，校验文件的合法性；如果上传参数源文件通知方式是 flag，源主机没有 flag 文件，就先生成 flag 文件并一起上传到目标地址；
  - [ ] (2) **上传资源的触发与调度** 上传资源命令的触发与调度都是通过任务调度引擎控制，可以进行定时任务触发，或者手动触发；
  - [ ] (3) **上传资源的执行情况监控** 上传资源命令的的执行情况统计，失败重试都是通过任务调度引擎监控与控制；
  - [ ] (4) **文件变化预警** 当文件正在分发或已完成分发，文件再次变化，文件分发服务能够及时检测到并预警提示，人工干预处理；
        **备注 1：** `没有标志文件的目录分发不支持文件变化预警`；
        **备注 2：** `公告文件和循环文件不支持文件变化预警`；

### 3.1.2 下载文件的功能需求

```go
// 下载资源命令需要的基本参数
源地址：下载资源的源地址（CSGW）
资源类型：资源类型是文件、目录
资源描述：资源的描述信息，可为空
目标地址：下载资源的主机
目标目录：下载资源存放的绝对路径
下载超时时间：默认是10s
源通知方式：F-flag文件，N-无flag文件
是否覆盖的标识：下载文件若已存在，在本地是否覆盖
重命名：下载文件在本地新的名称，如果名字已存在，则提示重命名失败
```

---

- **[config0 需要做]**

  - [x] (1) **从存储网关下载资源:** 任务调度引擎中的任务通过调用文件分发系统的下载命令和参数，设置下载源地址是 **CSGW**，资源类型，目标地址，目标目录等参数，进行资源下载；
  - [x] (2) **从文件分发系统下载资源:** 任务调度引擎中的任务通过调用文件分发系统的下载命令和参数，设置下载源地址是文件分发系统，资源类型，目标地址，目标目录等参数，进行资源下载；
  - [x] (3) **下载资源的超时控制:** 任务调度引擎中的任务通过调用文件分发系统的下载命令和参数，设置下载超时参数（默认是 10s）,超时则返回下载失败，并清理本地已下载的资源；
  - [x] (4) **资源的循环下载:** 任务调度引擎中的任务通过调用文件分发系统的下载命令和参数，执行定时下载 cron 定时任务表达式，时间间隔不得小于 2 倍的下载超时时间；

  - [x] (6) **下载文件名称已存在是否覆盖:** 任务调度引擎中的任务在调用文件分发系统下载命令时，如果下载文件已存在，则按照参数进行目标文件覆盖或者对目标文件重命名后再下载；

---

- **[config0 不需要做]**
  - [ ] (1) **对带有 flag 文件的校验:** 任务调度引擎中的任务在调用文件分发系统下载命令时，如果源文件通知方式是 Flag，则对下载的源文件和 flag 文件做校验，校验通过则证明数据是完整，表示下载成功，否则表示下载失败；

### 3.1.3 清理文件的功能需求

- **[config0 需要做]**
  - [x] (1) 通过文件分发系统下载的文件，设置有 TTL,当超过这个时间之后，下载的文件会自动被清理；
  - [x] (2)可以通过文件分发系统提供的命令，清理存储在文件分发系统中的文件；

## 3.2 文件分发调度与监控

- 文件分发系统操控中心对文件分发系统任务调度流程的调度与监控，合并到 G4 项目的操控中心。

# 4: 参考数据中心-文件分发系统非功能需求

- [ ] （1）文件分发系统可支持同时 200 台主机并发下载；并且主机数越多，下载完成时间缓慢增长，每增加一台下载主机，下载完成时间增长不超过 1%；
- [ ] （2）在 40G 带宽环境下，30 台主机（Intel Xeon 4114 CPU @ 2.2GHz,16 核，32G 内存，2T SSD 硬盘）可支持在 30s 内分发（下载） 2000 个大小是 50M~100M 的文件；

# 5: TODO:待补充

## 5.1 与存储网关的交互

## 5.2 flag 文件的生成与校验规则
